<!DOCTYPE HTML>
<html>
	<head>
		<!--TODO: Reconnect -->
		<title>CASTER 0.0.0</title>
		<script type="text/javascript" src="jquery-1.9.1.js">
		</script>
		<style type="text/css">
			#main_table td{
				border: solid 1px #444;
			}
			
			body {
				background-color: #333;
			}
			
			input, textarea {
				background-color: #555;
				border: 1px;
			}
			
			#field{
				font-family: monospace;
				border-width: 0px;
				border-collapse: collapse;
				-webkit-user-select: none; /* Chrome/Safari */        
				-moz-user-select: none; /* Firefox */
				-ms-user-select: none; /* IE10+ */
				cursor: default;
			}
			
			#field td.floor:hover{
				background-color: #464;
			}
			
		</style>
		
		<script>
			var anim_length = 200;
			var ws = new WebSocket('ws://'+document.location.host);
			var login;
			var game_state;
			var creatures;
			var populate = function(crtr){
		         tabBody=document.getElementById("creatures");
		         row=document.createElement("TR");
		         cell_id = document.createElement("TD");
		         cell_cls = document.createElement("TD");
		         cell_name = document.createElement("TD");
		         cell_use = document.createElement("BUTTON");
		         cell_use.innerText = "JOIN";
		         cell_use.onclick = function(){
		         	ws.send(JSON.stringify(
		         		{"what":"join",
		         		 "crid":crtr.id
		         		}
		         ));
		         }
		         textnode_id=document.createTextNode(crtr.id);
		         textnode_cls=document.createTextNode(crtr.cls);
		         textnode_name=document.createTextNode(crtr.name);
		         cell_id.appendChild(textnode_id);
		         cell_cls.appendChild(textnode_cls);
		         cell_name.appendChild(textnode_name);
		         row.appendChild(cell_id);
		         row.appendChild(cell_cls);
		         row.appendChild(cell_name);
		         row.appendChild(cell_use);
		         tabBody.appendChild(row);
			}
			ws.onmessage = function(message) {
				document.getElementsByName('output')[0].value += message.data+'\n';
				var obj = JSON.parse(message.data)
				switch(obj.what){
				
				case "login":
					$('#login_form').hide(anim_length);
					creatures = Array();
					obj.creatures.map(function(crtr){
						creatures[crtr.id] = crtr;
						populate(crtr)});
						
					$('#creatures').show(anim_length);
					break;
					
				case "joined":
					$('#creatures').hide(anim_length);
					$('#cr_info').show(anim_length);
					$('#cr_name').html(creatures[obj.crid].name);
					break;
					
				case "environment":
					map = []
					for (var i=0; i < obj.cells.length; i++){
						cell = obj.cells[i];
						var y = cell.coords[1]
						var x = cell.coords[0]
						if (typeof(map[y]) == "undefined"){
							map[y] = [];
						}
						map[y][x] = cell.type;
					}
					var str = "";
					for(var i=0; i< map.length; i++){
						str += "<tr>";
						for (var j = 0; j< map[i].length; j++){
							if (typeof(map[i][j]) == 'undefined'){
								map[i][j] = '*';
							}
							str += ('<td xpos="'+j+'" ypos="'+i+'" class="' + map[i][j] +'">'+
							           ((map[i][j] == 'floor')?'.':'#')+
							           '</td>');
						}
						str += "</tr>\n";
					}
					$("#field").html(str);
					$("#game_turn").html(obj.turn);
					break;
				case "responses":
					$("#game_turn").html(obj.turn+1);
				break;
					
				}
			};
			ws.onclose = function(){
				document.getElementsByName('output')[0].value += "DISCONNECTED\n";
			}
			function do_login(form)
			{
				f = document.getElementById('login_form')
				ws.send(JSON.stringify({what:"login", 
				                        login:f.login.value,
				                        passw:f.passw.value}))
				return false;
			}
			
			$(function(){
				$('body').on('click','#field td', function(e){
					xpos = e.toElement.getAttribute('xpos')
					ypos = e.toElement.getAttribute('ypos')
					//alert(xpos+", "+ypos);
				});
			});
		</script>
	</head>
	
	<body>
	<table id="main_table" width="100%">
		<tr>
			<td width="200px">
				<form id="login_form" method="post" onsubmit="return do_login(this);">
					<table>
						<tr>
							<td><label for="login">Login</label></td>
							<td><input type="text" name="login" value="demoth" id="login"/></td>
						</tr>
						<tr>
							<td><label for="passw">Pass</label></td>
							<td><input type="text" name="passw" value="asdf" id="passw"/></td>
						</tr>
						<tr><td><input type="submit" name="submit" value="Вход" id="submit" /></td></tr>
					</table>
				</form>
				
				<table id="creatures" style="border: solid 1px grey; display:none;">
					<tr><th>ID</th><th>Class</th><th>Name</th><th>Use</th></tr>
				</table>
				<div id="cr_info" style="display:none;">
					<h1 id="cr_name"></h1>
					<p id="cr_status">Awaiting join...</p>
					<p>HP:<span id="cr_hp">?</span></p>
					<p>MP:<span id="cr_mp">?</span></p>
					<p>TIME:<span id="cr_time">?</span></p>
					<h3>Actions:</h3>
					<!-- ADD table for actions-->
				</div>
			</td>
			<td>
				<table id="field">
				</table>
			</td>
			<td width="200px">
				<h3>Target:</h3>
				<div id="target_description">
					Nothing selected
				</div>
			</td>
		</tr>
		<tr>
			<td colspan="3">
				<textarea name="output" rows="15" cols="80"></textarea>
				<p> Turn #<span id="game_turn">?</span></p>
			</td>
		</tr>
	</table>
	</body>
</html>